<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ChatWorks - Admin Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <style>
        :root {
            /* BRAND */
            --accent: #8b5cf6;
            --accent-hover: #7c3aed;
            --accent-light: rgba(139, 92, 246, 0.1);
            --accent-glow: rgba(139, 92, 246, 0.15);

            /* LIGHT THEME (default) */
            --bg-primary: #ffffff;
            --bg-secondary: #f9fafb;
            --bg-tertiary: #f3f4f6;
            --bg-quaternary: #e5e7eb;

            --text-primary: #111827;
            --text-secondary: #374151;
            --text-tertiary: #6b7280;
            --text-muted: #9ca3af;

            --border: #e5e7eb;
            --border-hover: #d1d5db;

            /* STATUS */
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);

            /* SPACING */
            --radius-sm: 6px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;

            /* SHADOWS */
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-focus: 0 0 0 3px rgba(139, 92, 246, 0.15);

            --transition-fast: 150ms ease;
            --transition-base: 200ms ease;
        }

        /* DARK THEME */
        [data-theme="dark"] {
            --bg-primary: #0f0f14;
            --bg-secondary: #16161d;
            --bg-tertiary: #1e1e27;
            --bg-quaternary: #2a2a36;

            --text-primary: #f3f4f6;
            --text-secondary: #d1d5db;
            --text-tertiary: #9ca3af;
            --text-muted: #6b7280;

            --border: #2a2a36;
            --border-hover: #3f3f4a;

            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.4);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.5);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Open Sans', -apple-system, sans-serif;
            background: var(--bg-secondary);
            color: var(--text-primary);
            line-height: 1.6;
            overflow: hidden;
            height: 100vh;
            transition: background var(--transition-base), color var(--transition-base);
        }

        .mono {
            font-family: 'JetBrains Mono', monospace;
        }

        /* ═══════════════════════════════════════
           LOGIN OVERLAY
        ═══════════════════════════════════════ */
        .login-overlay {
            position: fixed;
            inset: 0;
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            transition: opacity 0.4s ease, visibility 0.4s ease;
        }

        .login-overlay.hidden {
            opacity: 0;
            visibility: hidden;
            pointer-events: none;
            display: none;
        }

        .login-card {
            width: 100%;
            max-width: 400px;
            padding: 40px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-xl);
            animation: slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .login-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 8px;
        }

        .login-brand svg {
            width: 32px;
            height: 32px;
            color: var(--accent);
        }

        .login-brand h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .login-subtitle {
            color: var(--text-tertiary);
            margin-bottom: 32px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .form-input::placeholder {
            color: var(--text-muted);
        }

        .form-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--shadow-focus);
            background: var(--bg-primary);
        }

        .form-select {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M4.646 5.646a.5.5 0 0 1 .708 0L8 8.293l2.646-2.647a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 12px center;
            padding-right: 40px;
            transition: all var(--transition-fast);
        }

        .form-select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--shadow-focus);
        }

        .btn {
            padding: 12px 20px;
            border-radius: var(--radius-md);
            font-size: 14px;
            font-weight: 600;
            font-family: inherit;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all var(--transition-fast);
            border: none;
        }

        .btn svg {
            width: 16px;
            height: 16px;
        }

        .btn-primary {
            width: 100%;
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
            transform: translateY(-1px);
        }

        .btn-accent {
            background: var(--accent);
            color: white;
        }

        .btn-accent:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .btn-secondary:hover {
            background: var(--bg-quaternary);
            border-color: var(--accent);
            color: var(--accent);
        }

        .btn-ghost {
            background: transparent;
            color: var(--text-secondary);
            padding: 8px 12px;
        }

        .btn-ghost:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .error-msg {
            color: var(--danger);
            font-size: 13px;
            margin-top: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        /* ═══════════════════════════════════════
           APP SHELL
        ═══════════════════════════════════════ */
        .app-shell {
            display: flex;
            height: 100vh;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.4s ease;
        }

        .app-shell.visible {
            opacity: 1;
            pointer-events: auto;
        }

        /* ═══════════════════════════════════════
           SIDEBAR
        ═══════════════════════════════════════ */
        .sidebar {
            width: 250px;
            background: var(--bg-primary);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 16px;
            flex-shrink: 0;
            transition: background var(--transition-base), border-color var(--transition-base);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 0 12px 20px;
            border-bottom: 1px solid var(--border);
            margin-bottom: 20px;
        }

        .sidebar-brand svg {
            width: 28px;
            height: 28px;
            color: var(--accent);
        }

        .sidebar-brand-text h2 {
            font-size: 18px;
            font-weight: 700;
            color: var(--accent);
        }

        .sidebar-brand-text span {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 10px 12px;
            border-radius: var(--radius-md);
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: 4px;
        }

        .nav-link svg {
            width: 20px;
            height: 20px;
            opacity: 0.7;
        }

        .nav-link:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .nav-link:hover svg {
            opacity: 1;
        }

        .nav-link.active {
            background: var(--accent-light);
            color: var(--accent);
            font-weight: 600;
        }

        .nav-link.active svg {
            opacity: 1;
            color: var(--accent);
        }

        .nav-badge {
            margin-left: auto;
            background: var(--accent);
            color: white;
            font-size: 10px;
            font-weight: 700;
            padding: 2px 8px;
            border-radius: 99px;
        }

        .sidebar-footer {
            margin-top: auto;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }

        .user-card {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            margin-bottom: 10px;
        }

        .user-avatar {
            width: 36px;
            height: 36px;
            background: var(--accent);
            border-radius: var(--radius-sm);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 13px;
            color: white;
        }

        .user-info {
            flex: 1;
            min-width: 0;
        }

        .user-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-role {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        .logout-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            width: 100%;
            padding: 10px;
            background: transparent;
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-tertiary);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .logout-btn:hover {
            background: var(--danger-bg);
            border-color: var(--danger);
            color: var(--danger);
        }

        .logout-btn svg {
            width: 16px;
            height: 16px;
        }

        /* ═══════════════════════════════════════
           MAIN CONTENT
        ═══════════════════════════════════════ */
        .main-content {
            flex: 1;
            overflow-y: auto;
            background: var(--bg-secondary);
            transition: background var(--transition-base);
        }

        .view {
            padding: 32px;
            max-width: 1400px;
            margin: 0 auto;
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .view.active {
            display: block;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
            }

            to {
                opacity: 1;
            }
        }

        .page-header {
            margin-bottom: 28px;
        }

        .page-header h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .page-header p {
            color: var(--text-tertiary);
            font-size: 14px;
        }

        .header-row {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 20px;
        }

        .btn-group {
            display: flex;
            gap: 8px;
        }

        /* ═══════════════════════════════════════
           CARDS
        ═══════════════════════════════════════ */
        .card {
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-base);
        }

        .card:hover {
            border-color: var(--border-hover);
        }

        .card-header {
            padding: 16px 20px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .card-body {
            padding: 20px;
        }

        /* ═══════════════════════════════════════
           STAT CARDS
        ═══════════════════════════════════════ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 24px;
        }

        .stat-card {
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            background: var(--accent-light);
            color: var(--accent);
        }

        .stat-icon svg {
            width: 24px;
            height: 24px;
        }

        .stat-content {
            flex: 1;
        }

        .stat-label {
            font-size: 12px;
            font-weight: 700;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 2px;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 600;
            color: var(--text-primary);
            font-family: 'JetBrains Mono', monospace;
        }

        .stat-change {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
            padding: 2px 6px;
            border-radius: 99px;
        }

        .stat-change.up {
            background: var(--success-bg);
            color: var(--success);
        }

        .stat-change.down {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .stat-change svg {
            width: 10px;
            height: 10px;
        }

        /* ═══════════════════════════════════════
           CHARTS
        ═══════════════════════════════════════ */
        .chart-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
            margin-bottom: 24px;
        }

        .chart-container {
            height: 260px;
            position: relative;
        }

        .engagement-card {
            text-align: center;
            display: flex;
            flex-direction: column;
            justify-content: center;
            padding: 24px;
        }

        .engagement-value {
            font-size: 48px;
            font-weight: 700;
            font-family: 'JetBrains Mono', monospace;
            color: var(--text-primary);
            line-height: 1;
            margin-bottom: 6px;
        }

        .engagement-label {
            color: var(--text-tertiary);
            font-size: 14px;
            margin-bottom: 20px;
        }

        .progress-bar {
            height: 10px;
            background: var(--bg-tertiary);
            border-radius: 99px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .progress-fill {
            height: 100%;
            background: var(--accent);
            border-radius: 99px;
            transition: width 1s ease;
        }

        .progress-label {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════
           DATA TABLE
        ═══════════════════════════════════════ */
        .table-wrapper {
            overflow-x: auto;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            text-align: left;
            padding: 12px 16px;
            background: var(--bg-secondary);
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            border-bottom: 1px solid var(--border);
            white-space: nowrap;
        }

        .data-table td {
            padding: 14px 16px;
            font-size: 13px;
            border-bottom: 1px solid var(--border);
            color: var(--text-secondary);
        }

        .data-table tbody tr {
            transition: background var(--transition-fast);
        }

        .data-table tbody tr:hover {
            background: var(--bg-tertiary);
        }

        .data-table tbody tr:last-child td {
            border-bottom: none;
        }

        .table-prompt {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .table-avatar {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-sm);
            background: var(--accent);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 11px;
            color: white;
            flex-shrink: 0;
        }

        .table-name {
            font-weight: 600;
            color: var(--text-primary);
            font-size: 13px;
        }

        .table-desc {
            font-size: 11px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════
           BADGES
        ═══════════════════════════════════════ */
        .badge {
            display: inline-flex;
            align-items: center;
            padding: 3px 8px;
            border-radius: 99px;
            font-size: 10px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .badge-pro {
            background: linear-gradient(135deg, #fbbf24 0%, #f59e0b 100%);
            color: #78350f;
            box-shadow: 0 1px 3px rgba(251, 191, 36, 0.3);
        }

        .badge-free {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            border: 1px solid var(--border);
        }

        .badge-active {
            background: var(--success-bg);
            color: var(--success);
        }

        .badge-inactive {
            background: var(--bg-tertiary);
            color: var(--text-muted);
        }

        .badge-category {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
            font-size: 10px;
            padding: 2px 8px;
            border: 1px solid var(--border);
        }

        /* ═══════════════════════════════════════
           QUERY CONSOLE
        ═══════════════════════════════════════ */
        .console-grid {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 24px;
            min-height: 500px;
        }

        .console-sidebar {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .console-output {
            background: #0f172a;
            border-radius: var(--radius-md);
            padding: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            color: #f1f5f9;
            overflow: auto;
        }

        .console-line {
            margin-bottom: 4px;
        }

        .console-line.success {
            color: var(--success);
        }

        .console-line.error {
            color: var(--danger);
        }

        .console-line.info {
            color: #38bdf8;
        }

        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 12px;
        }

        .result-table th {
            text-align: left;
            padding: 8px;
            border-bottom: 1px solid #334155;
            color: #94a3b8;
            font-size: 11px;
        }

        .result-table td {
            padding: 8px;
            border-bottom: 1px solid #1e293b;
            font-size: 12px;
        }

        /* ═══════════════════════════════════════
           MARKETPLACE FILTERS
        ═══════════════════════════════════════ */
        .marketplace-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
            margin-bottom: 20px;
        }

        .search-box {
            position: relative;
            flex: 1;
            max-width: 280px;
        }

        .search-box svg {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            width: 16px;
            height: 16px;
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-input {
            width: 100%;
            padding: 10px 12px 10px 38px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            transition: all var(--transition-fast);
        }

        .search-input::placeholder {
            color: var(--text-muted);
        }

        .search-input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: var(--shadow-focus);
        }

        .filter-select {
            padding: 10px 36px 10px 12px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 13px;
            font-family: inherit;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' fill='%236b7280' viewBox='0 0 16 16'%3E%3Cpath d='M4.646 5.646a.5.5 0 0 1 .708 0L8 8.293l2.646-2.647a.5.5 0 0 1 .708.708l-3 3a.5.5 0 0 1-.708 0l-3-3a.5.5 0 0 1 0-.708z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
        }

        .filter-select:focus {
            outline: none;
            border-color: var(--accent);
        }

        /* ═══════════════════════════════════════
           ACTION BUTTONS
        ═══════════════════════════════════════ */
        .action-btn {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .action-btn:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .action-btn.danger:hover {
            background: var(--danger-bg);
            color: var(--danger);
        }

        .action-btn svg {
            width: 14px;
            height: 14px;
        }

        .actions-cell {
            display: flex;
            gap: 4px;
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        tr:hover .actions-cell {
            opacity: 1;
        }

        /* ═══════════════════════════════════════
           MODALS
        ═══════════════════════════════════════ */
        .modal-overlay {
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(0, 0, 0, 0.3);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            opacity: 0;
            visibility: hidden;
            transition: all var(--transition-base);
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal {
            width: 100%;
            max-width: 600px;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-xl);
            transform: translateY(20px) scale(0.98);
            transition: transform var(--transition-base);
            overflow: hidden;
        }

        .modal-overlay.active .modal {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: var(--bg-secondary);
        }

        .modal-title {
            font-size: 15px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            width: 28px;
            height: 28px;
            border-radius: var(--radius-sm);
            background: transparent;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
        }

        .modal-close:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 24px;
        }

        .modal-footer {
            padding: 16px 24px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            background: var(--bg-secondary);
        }

        .modal-footer .btn {
            min-width: 100px;
        }

        /* Form Grid */
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            display: block;
            font-size: 11px;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 6px;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Radio Group */
        .radio-group {
            display: flex;
            gap: 16px;
            margin-top: 8px;
        }

        .radio-label {
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 13px;
            color: var(--text-secondary);
        }

        .radio-label input {
            width: auto;
        }

        /* Toggle Switch */
        .toggle-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 8px;
        }

        .toggle {
            position: relative;
            width: 40px;
            height: 22px;
            background: var(--bg-quaternary);
            border-radius: 99px;
            cursor: pointer;
            transition: background var(--transition-fast);
        }

        .toggle::after {
            content: '';
            position: absolute;
            left: 3px;
            top: 3px;
            width: 16px;
            height: 16px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition-fast);
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .toggle.active {
            background: var(--success);
        }

        .toggle.active::after {
            transform: translateX(18px);
        }

        .toggle-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* ═══════════════════════════════════════
           SETTINGS VIEW
        ═══════════════════════════════════════ */
        .settings-section {
            margin-bottom: 32px;
        }

        .settings-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 16px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border);
        }

        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border);
        }

        .setting-row:last-child {
            border-bottom: none;
        }

        .setting-info h4 {
            font-size: 14px;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .setting-info p {
            font-size: 12px;
            color: var(--text-tertiary);
        }

        /* ═══════════════════════════════════════
           BULK DELETE BAR
        ═══════════════════════════════════════ */
        .bulk-bar {
            display: none;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--danger-bg);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: var(--radius-md);
            margin-bottom: 16px;
        }

        .bulk-bar.visible {
            display: flex;
        }

        .bulk-bar span {
            font-size: 13px;
            font-weight: 500;
            color: var(--danger);
        }

        /* ═══════════════════════════════════════
           RESPONSIVE
        ═══════════════════════════════════════ */
        @media (max-width: 1200px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }

            .chart-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 900px) {
            .sidebar {
                display: none;
            }

            .console-grid {
                grid-template-columns: 1fr;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .form-group.full-width {
                grid-column: span 1;
            }
        }

        @media (max-width: 600px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }

            .view {
                padding: 20px;
            }
        }

        /* ═══════════════════════════════════════
           CUSTOM DROPDOWN
        ═══════════════════════════════════════ */
        .custom-dropdown {
            position: relative;
            width: 100%;
        }

        .dropdown-trigger {
            width: 100%;
            padding: 12px 16px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-size: 14px;
            font-family: inherit;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            transition: all var(--transition-fast);
            user-select: none;
        }

        .dropdown-trigger:hover {
            border-color: var(--text-muted);
            background: var(--bg-secondary);
        }

        .dropdown-trigger.active {
            border-color: var(--accent);
            box-shadow: var(--shadow-focus);
        }

        .dropdown-trigger-text {
            flex: 1;
            text-align: left;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .dropdown-trigger-text.placeholder {
            color: var(--text-muted);
        }

        .dropdown-icon {
            width: 16px;
            height: 16px;
            margin-left: 8px;
            transition: transform var(--transition-fast);
            flex-shrink: 0;
        }

        .dropdown-trigger.active .dropdown-icon {
            transform: rotate(180deg);
        }

        .dropdown-menu {
            position: absolute;
            top: calc(100% + 4px);
            left: 0;
            right: 0;
            background: var(--bg-primary);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            opacity: 0;
            transform: translateY(-8px);
            pointer-events: none;
            transition: all var(--transition-fast);
        }

        .dropdown-menu.active {
            opacity: 1;
            transform: translateY(0);
            pointer-events: all;
        }

        .dropdown-option {
            padding: 10px 16px;
            cursor: pointer;
            transition: all var(--transition-fast);
            color: var(--text-primary);
            font-size: 14px;
            border-bottom: 1px solid var(--border);
        }

        .dropdown-option:last-child {
            border-bottom: none;
        }

        .dropdown-option:hover {
            background: var(--bg-tertiary);
        }

        .dropdown-option.selected {
            background: var(--accent-light);
            color: var(--accent);
            font-weight: 600;
        }

        /* Removed checkmark icon from selected items */

        /* Scrollbar styling for dropdown */
        .dropdown-menu::-webkit-scrollbar {
            width: 6px;
        }

        .dropdown-menu::-webkit-scrollbar-track {
            background: transparent;
        }

        .dropdown-menu::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        .dropdown-menu::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
    </style>
</head>

<body>
    <!-- LOGIN OVERLAY -->
    <div class="login-overlay" id="loginOverlay">
        <div class="login-card">
            <div class="login-brand">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                    <path d="M12 2L2 7l10 5 10-5-10-5z" />
                    <path d="M2 17l10 5 10-5" />
                    <path d="M2 12l10 5 10-5" />
                </svg>
                <img src="images/AI%20ChatWorks.svg" alt="AI ChatWorks"
                    style="width: 48px; height: 48px; margin-bottom: 16px;">
                <h1>AI ChatWorks</h1>
            </div>
            <p class="login-subtitle">Admin Dashboard</p>
            <form id="loginForm">
                <div class="form-group">
                    <label>Email Address</label>
                    <input type="email" class="form-input" id="loginEmail" placeholder="admin@example.com">
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="Password">
                </div>
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    Sign In
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4" />
                        <polyline points="10 17 15 12 10 7" />
                        <line x1="15" y1="12" x2="3" y2="12" />
                    </svg>
                </button>
                <div class="error-msg" id="loginError" style="display: none;">
                    <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="10" />
                        <line x1="12" y1="8" x2="12" y2="12" />
                        <line x1="12" y1="16" x2="12.01" y2="16" />
                    </svg>
                    Invalid credentials
                </div>
            </form>
        </div>
    </div>

    <!-- APP SHELL -->
    <div class="app-shell" id="appShell">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="sidebar-brand">
                <img src="images/AI%20ChatWorks.svg" alt="AI ChatWorks" style="width: 32px; height: 32px;"
                    onerror="this.style.display='none'">
                <div class="sidebar-brand-text">
                    <h2>AI ChatWorks</h2>
                    <span>Admin Dashboard</span>
                </div>
            </div>

            <nav>
                <div class="nav-section">
                    <div class="nav-link active" data-view="overview">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <rect x="3" y="3" width="7" height="7" />
                            <rect x="14" y="3" width="7" height="7" />
                            <rect x="14" y="14" width="7" height="7" />
                            <rect x="3" y="14" width="7" height="7" />
                        </svg>
                        Overview
                    </div>
                    <div class="nav-link" data-view="queries">
                        <svg width="20" height="20" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M14.5 2.49866C14.5 3.60194 11.366 4.49731 7.5 4.49731C3.634 4.49731 0.5 3.60194 0.5 2.49866M14.5 2.49866C14.5 1.39538 11.366 0.5 7.5 0.5C3.634 0.5 0.5 1.39538 0.5 2.49866M14.5 2.49866V12.4922C14.5 13.5955 11.366 14.4908 7.5 14.4908C3.634 14.4908 0.5 13.5956 0.5 12.4923V2.49866M14.5 7.49536C14.5 8.59864 11.366 9.49414 7.5 9.49414C3.634 9.49414 0.5 8.59864 0.5 7.49536"
                                stroke="currentColor" stroke-linecap="square" />
                        </svg>
                        DB Queries
                    </div>
                    <div class="nav-link" data-view="marketplace">
                        <svg width="20" height="20" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                            fill="currentColor">
                            <path
                                d="M2.7,9.45a4.235,4.235,0,0,0,.3.3V22a1,1,0,0,0,1,1H20a1,1,0,0,0,1-1V9.752a4.235,4.235,0,0,0,.3-.3,4,4,0,0,0,.731-3.456L20.97,1.758A1,1,0,0,0,20,1H4a1,1,0,0,0-.97.758L1.972,5.994A4,4,0,0,0,2.7,9.45ZM13,21H11V16h2Zm6,0H15V15a1,1,0,0,0-1-1H10a1,1,0,0,0-1,1v6H5V10.9A3.989,3.989,0,0,0,8.914,9.61c.026.03.053.059.08.089A4.086,4.086,0,0,0,12.041,11a4.039,4.039,0,0,0,2.965-1.3c.027-.03.054-.059.08-.089A3.989,3.989,0,0,0,19,10.9ZM3.911,6.479,4.781,3H19.219l.87,3.479A2.029,2.029,0,0,1,18.12,9,2.041,2.041,0,0,1,16.1,7.14l-.042-.5a1,1,0,0,0-1.993.166v0a2.006,2.006,0,0,1-.529,1.539A2.059,2.059,0,0,1,11.959,9,2.029,2.029,0,0,1,9.937,6.806v0a1,1,0,0,0-.914-1.079.989.989,0,0,0-1.079.913l-.042.5A2.041,2.041,0,0,1,5.88,9,2.029,2.029,0,0,1,3.911,6.479Z">
                            </path>
                        </svg>
                        Marketplace
                        <span class="nav-badge" id="marketplaceBadge">0</span>
                    </div>
                    <div class="nav-link" data-view="settings">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                            <circle cx="12" cy="12" r="3" />
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                        </svg>
                        Settings
                    </div>
                </div>
            </nav>

            <div class="sidebar-footer">
                <div class="user-card">
                    <div class="user-avatar" id="userAvatar">AD</div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Admin User</div>
                        <div class="user-role">Super Admin</div>
                    </div>
                </div>
                <button class="logout-btn" id="logoutBtn">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                        <polyline points="16 17 21 12 16 7" />
                        <line x1="21" y1="12" x2="9" y2="12" />
                    </svg>
                    Sign Out
                </button>
            </div>
        </aside>

        <!-- MAIN CONTENT -->
        <main class="main-content">
            <!-- OVERVIEW VIEW -->
            <div class="view active" id="viewOverview">
                <div class="page-header">
                    <div class="header-row">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <rect x="3" y="3" width="7" height="7" />
                                    <rect x="14" y="3" width="7" height="7" />
                                    <rect x="14" y="14" width="7" height="7" />
                                    <rect x="3" y="14" width="7" height="7" />
                                </svg>
                                <h1>Dashboard Overview</h1>
                            </div>
                            <p>Real-time platform metrics</p>
                        </div>
                        <button class="btn btn-secondary" onclick="refreshData()">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M23 4v6h-6" />
                                <path d="M1 20v-6h6" />
                                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                            </svg>
                            Refresh
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="card stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                                <circle cx="9" cy="7" r="4" />
                                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Total Users</div>
                            <div class="stat-value" id="statUsers">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Total Prompts</div>
                            <div class="stat-value" id="statPrompts">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Folders</div>
                            <div class="stat-value" id="statFolders">-</div>
                        </div>
                    </div>
                    <div class="card stat-card">
                        <div class="stat-icon">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <rect x="3" y="11" width="18" height="11" rx="2" ry="2" />
                                <path d="M7 11V7a5 5 0 0 1 10 0v4" />
                            </svg>
                        </div>
                        <div class="stat-content">
                            <div class="stat-label">Encrypted</div>
                            <div class="stat-value" id="statEncrypted">-</div>
                        </div>
                    </div>
                </div>

                <div class="chart-grid">
                    <div class="card">
                        <div class="card-header">
                            <span class="card-title">User Growth (30 Days)</span>
                        </div>
                        <div class="card-body">
                            <div class="chart-container">
                                <canvas id="growthChart"></canvas>
                            </div>
                        </div>
                    </div>
                    <div class="card engagement-card">
                        <div class="engagement-value" id="engagementValue">-</div>
                        <div class="engagement-label">Active Users This Month</div>
                        <div class="progress-bar">
                            <div class="progress-fill" id="engagementBar" style="width: 0%"></div>
                        </div>
                        <div class="progress-label"><span id="engagementPercent">0</span>% of total users</div>
                    </div>
                </div>

                <!-- Marketplace Stats Section -->
                <div class="card" style="margin-bottom: 24px;">
                    <div class="card-header">
                        <span class="card-title">Marketplace Stats</span>
                    </div>
                    <div class="card-body" style="padding: 0;">
                        <div class="stats-grid" style="margin-bottom: 0; padding: 20px; gap: 16px;">
                            <div class="card stat-card" style="border: 1px solid var(--border);">
                                <div class="stat-icon">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Total Prompts</div>
                                    <div class="stat-value" id="mpTotalPrompts">-</div>
                                </div>
                            </div>
                            <div class="card stat-card" style="border: 1px solid var(--border);">
                                <div class="stat-icon" style="background: var(--warning-bg); color: var(--warning);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <polygon
                                            points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Pro Prompts</div>
                                    <div class="stat-value" id="mpProPrompts">-</div>
                                </div>
                            </div>
                            <div class="card stat-card" style="border: 1px solid var(--border);">
                                <div class="stat-icon" style="background: var(--success-bg); color: var(--success);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z" />
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Free Prompts</div>
                                    <div class="stat-value" id="mpFreePrompts">-</div>
                                </div>
                            </div>
                            <div class="card stat-card" style="border: 1px solid var(--border);">
                                <div class="stat-icon" style="background: var(--danger-bg); color: var(--danger);">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                        <circle cx="12" cy="12" r="10" />
                                        <line x1="4.93" y1="4.93" x2="19.07" y2="19.07" />
                                    </svg>
                                </div>
                                <div class="stat-content">
                                    <div class="stat-label">Inactive Prompts</div>
                                    <div class="stat-value" id="mpInactivePrompts">-</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <span class="card-title">Top Downloaded Prompts</span>
                        <button class="btn btn-ghost" onclick="switchView('marketplace')">View All →</button>
                    </div>
                    <div class="table-wrapper">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Prompt Name</th>
                                    <th>Category</th>
                                    <th>Downloads</th>
                                    <th>Tier</th>
                                </tr>
                            </thead>
                            <tbody id="topPromptsTable">
                                <tr>
                                    <td colspan="4" style="text-align: center; color: var(--text-muted);">Loading...
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- DB QUERIES VIEW -->
            <div class="view" id="viewQueries">
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <svg width="24" height="24" viewBox="0 0 15 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M14.5 2.49866C14.5 3.60194 11.366 4.49731 7.5 4.49731C3.634 4.49731 0.5 3.60194 0.5 2.49866M14.5 2.49866C14.5 1.39538 11.366 0.5 7.5 0.5C3.634 0.5 0.5 1.39538 0.5 2.49866M14.5 2.49866V12.4922C14.5 13.5955 11.366 14.4908 7.5 14.4908C3.634 14.4908 0.5 13.5956 0.5 12.4923V2.49866M14.5 7.49536C14.5 8.59864 11.366 9.49414 7.5 9.49414C3.634 9.49414 0.5 8.59864 0.5 7.49536"
                                stroke="currentColor" stroke-width="1" stroke-linecap="square" />
                        </svg>
                        <h1>Database Console</h1>
                    </div>
                    <p>Run secure queries directly on the database</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="console-grid">
                            <div class="console-sidebar">
                                <div class="form-group">
                                    <label>Select Query</label>
                                    <select class="form-select" id="querySelector" onchange="updateQueryParams()">
                                        <option value="recent_users">Recent Users</option>
                                        <option value="find_user">Find User by Email</option>
                                        <option value="heavy_users">Heavy Users (Most Prompts)</option>
                                        <option value="inactive_users">Inactive Users</option>
                                        <option value="marketplace_prompts">Marketplace Prompts</option>
                                        <option value="top_downloads">Top Downloads</option>
                                        <option value="db_stats">Database Statistics</option>
                                    </select>
                                </div>

                                <div id="queryParams">
                                    <div class="form-group">
                                        <label>Limit Results</label>
                                        <input type="number" class="form-input" id="paramLimit" value="10" min="1"
                                            max="100">
                                    </div>
                                </div>

                                <div style="margin-top: auto;">
                                    <button class="btn btn-primary" onclick="runQuery()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                            <polygon points="5 3 19 12 5 21 5 3" />
                                        </svg>
                                        Run Query
                                    </button>
                                </div>
                            </div>

                            <div class="console-output" id="consoleOutput">
                                <div class="console-line info">// Ready to execute queries...</div>
                                <div class="console-line">// Select a query and click Run Query</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- MARKETPLACE VIEW -->
            <div class="view" id="viewMarketplace">
                <div class="page-header">
                    <div class="header-row">
                        <div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <svg width="24" height="24" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"
                                    fill="currentColor">
                                    <path
                                        d="M2.7,9.45a4.235,4.235,0,0,0,.3.3V22a1,1,0,0,0,1,1H20a1,1,0,0,0,1-1V9.752a4.235,4.235,0,0,0,.3-.3,4,4,0,0,0,.731-3.456L20.97,1.758A1,1,0,0,0,20,1H4a1,1,0,0,0-.97.758L1.972,5.994A4,4,0,0,0,2.7,9.45ZM13,21H11V16h2Zm6,0H15V15a1,1,0,0,0-1-1H10a1,1,0,0,0-1,1v6H5V10.9A3.989,3.989,0,0,0,8.914,9.61c.026.03.053.059.08.089A4.086,4.086,0,0,0,12.041,11a4.039,4.039,0,0,0,2.965-1.3c.027-.03.054-.059.08-.089A3.989,3.989,0,0,0,19,10.9ZM3.911,6.479,4.781,3H19.219l.87,3.479A2.029,2.029,0,0,1,18.12,9,2.041,2.041,0,0,1,16.1,7.14l-.042-.5a1,1,0,0,0-1.993.166v0a2.006,2.006,0,0,1-.529,1.539A2.059,2.059,0,0,1,11.959,9,2.029,2.029,0,0,1,9.937,6.806v0a1,1,0,0,0-.914-1.079.989.989,0,0,0-1.079.913l-.042.5A2.041,2.041,0,0,1,5.88,9,2.029,2.029,0,0,1,3.911,6.479Z">
                                    </path>
                                </svg>
                                <h1>Marketplace</h1>
                            </div>
                            <p>Manage your prompt library</p>
                        </div>
                        <div class="btn-group">
                            <button class="btn btn-secondary" onclick="openBulkUploadModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
                                    <polyline points="17 8 12 3 7 8" />
                                    <line x1="12" y1="3" x2="12" y2="15" />
                                </svg>
                                Bulk Upload
                            </button>
                            <button class="btn btn-secondary" onclick="refreshMarketplace()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                                    style="width: 16px; height: 16px;">
                                    <path d="M23 4v6h-6" />
                                    <path d="M1 20v-6h6" />
                                    <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15" />
                                </svg>
                                Refresh
                            </button>
                            <button class="btn btn-accent" onclick="openCreatePromptModal()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <line x1="12" y1="5" x2="12" y2="19" />
                                    <line x1="5" y1="12" x2="19" y2="12" />
                                </svg>
                                New Prompt
                            </button>
                            <button class="btn btn-secondary" onclick="openManageCategoriesModal()">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                                    stroke-width="2">
                                    <path d="M4 6h16M4 12h16M4 18h16" />
                                </svg>
                                Manage Categories
                            </button>
                        </div>
                    </div>
                </div>

                <div class="card" style="margin-bottom: 20px;">
                    <div class="card-body" style="padding: 16px 20px;">
                        <div class="marketplace-toolbar">
                            <div class="search-box">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <circle cx="11" cy="11" r="8" />
                                    <path d="m21 21-4.35-4.35" />
                                </svg>
                                <input type="text" class="search-input" placeholder="Search prompts..."
                                    id="marketplaceSearch" oninput="filterMarketplace()">
                            </div>
                            <div style="display: flex; gap: 8px;">
                                <select class="filter-select" id="categoryFilter" onchange="filterMarketplace()"
                                    style="min-width: 185px; height: 38.9px;">
                                    <option value="">All Categories</option>
                                </select>
                                <select class="filter-select" id="tierFilter" onchange="filterMarketplace()"
                                    style="min-width: 145px; height: 38.9px;">
                                    <option value="">All Tiers</option>
                                    <option value="pro">Pro</option>
                                    <option value="free">Free</option>
                                </select>
                                <button class="btn btn-ghost" onclick="clearFilters()">Clear</button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Bulk Delete Bar -->
                <div class="bulk-bar" id="bulkDeleteBar">
                    <span><span id="selectedCount">0</span> prompt(s) selected</span>
                    <button class="btn btn-danger" onclick="bulkDeletePrompts()">Delete Selected</button>
                </div>

                <div class="card">
                    <div class="table-wrapper">
                        <table class="data-table" id="marketplaceTable">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" onchange="toggleAllPrompts(this.checked)"
                                            style="cursor: pointer;">
                                    </th>
                                    <th>Prompt Name</th>
                                    <th>Category</th>
                                    <th>Updated By</th>
                                    <th>Downloads</th>
                                    <th>Tier</th>
                                    <th>Status</th>
                                    <th style="width: 80px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="marketplaceTableBody">
                                <tr>
                                    <td colspan="8"
                                        style="text-align: center; color: var(--text-muted); padding: 40px;">Loading
                                        marketplace data...</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div class="view" id="viewSettings">
                <div class="page-header">
                    <div style="display: flex; align-items: center; gap: 12px;">
                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                            stroke-width="2">
                            <circle cx="12" cy="12" r="3" />
                            <path
                                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
                        </svg>
                        <h1>Settings</h1>
                    </div>
                    <p>Configure your dashboard preferences</p>
                </div>

                <div class="card">
                    <div class="card-body">
                        <div class="settings-section">
                            <h3>Appearance</h3>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Dark Mode</h4>
                                    <p>Switch between light and dark theme</p>
                                </div>
                                <div class="toggle" id="themeToggle" onclick="toggleTheme()"></div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>Account</h3>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Email</h4>
                                    <p id="settingsEmail"><a href="/cdn-cgi/l/email-protection" class="__cf_email__"
                                            data-cfemail="0b6a6f6662654b6a6268636a7f7c6479607825686466">[email&#160;protected]</a>
                                    </p>
                                </div>
                            </div>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Role</h4>
                                    <p>Super Admin</p>
                                </div>
                            </div>
                        </div>

                        <div class="settings-section">
                            <h3>About</h3>
                            <div class="setting-row">
                                <div class="setting-info">
                                    <h4>Version</h4>
                                    <p>Admin Dashboard v2.0</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- CREATE PROMPT MODAL -->
    <div class="modal-overlay" id="createPromptModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">New Prompt</span>
                <button class="modal-close" onclick="closeModal('createPromptModal')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <div class="form-row">
                    <div class="form-group">
                        <label>Prompt Name</label>
                        <input type="text" class="form-input" id="createPromptName" placeholder="e.g. SEO Writer">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-select" id="createPromptCategory">
                            <option value="">Select Category</option>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tier</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="createTier" value="free" checked> Free
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="createTier" value="pro"> Pro
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="toggle-wrapper">
                            <div class="toggle active" id="createStatusToggle"
                                onclick="this.classList.toggle('active')"></div>
                            <span class="toggle-label">Active</span>
                        </div>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Description</label>
                    <textarea class="form-input" id="createPromptDesc" rows="2"
                        placeholder="Short description..."></textarea>
                </div>
                <div class="form-group full-width">
                    <label>System Prompt</label>
                    <textarea class="form-input mono" id="createPromptContent" rows="5"
                        placeholder="You are a helpful assistant..." style="font-size: 12px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('createPromptModal')">Cancel</button>
                <button class="btn btn-accent" onclick="createPrompt()">Create Prompt</button>
            </div>
        </div>
    </div>

    <!-- EDIT PROMPT MODAL -->
    <div class="modal-overlay" id="editPromptModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Edit Prompt</span>
                <button class="modal-close" onclick="closeModal('editPromptModal')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="editPromptId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Prompt Name</label>
                        <input type="text" class="form-input" id="editPromptName">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select class="form-select" id="editPromptCategory">
                            <option value="">Select Category</option>
                            <!-- Categories will be populated dynamically -->
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Tier</label>
                        <div class="radio-group">
                            <label class="radio-label">
                                <input type="radio" name="editTier" value="free"> Free
                            </label>
                            <label class="radio-label">
                                <input type="radio" name="editTier" value="pro"> Pro
                            </label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Status</label>
                        <div class="toggle-wrapper">
                            <div class="toggle" id="editStatusToggle" onclick="this.classList.toggle('active')"></div>
                            <span class="toggle-label">Active</span>
                        </div>
                    </div>
                </div>
                <div class="form-group full-width">
                    <label>Description</label>
                    <textarea class="form-input" id="editPromptDesc" rows="2"></textarea>
                </div>
                <div class="form-group full-width">
                    <label>System Prompt</label>
                    <textarea class="form-input mono" id="editPromptContent" rows="5"
                        style="font-size: 12px;"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('editPromptModal')">Cancel</button>
                <button class="btn btn-accent" onclick="updatePrompt()">Update Prompt</button>
            </div>
        </div>
    </div>

    <!-- MANAGE CATEGORIES MODAL -->
    <div class="modal-overlay" id="manageCategoriesModal">
        <div class="modal" style="max-width: 600px;">
            <div class="modal-header">
                <span class="modal-title">Manage Categories</span>
                <button class="modal-close" onclick="closeModal('manageCategoriesModal')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body" style="padding: 20px;">
                <!-- Add New Category -->
                <div
                    style="margin-bottom: 20px; padding: 12px; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                    <label
                        style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Add
                        New Category</label>
                    <div style="display: flex; gap: 8px;">
                        <input type="text" id="newCategoryInput" class="form-input" placeholder="Enter category name"
                            style="flex: 1; padding: 10px 12px;">
                        <button class="btn btn-accent" onclick="addCategory()" style="padding: 10px 20px;">Add</button>
                    </div>
                </div>

                <!-- Categories List -->
                <div>
                    <label
                        style="display: block; margin-bottom: 10px; font-weight: 600; font-size: 12px; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.5px;">Existing
                        Categories</label>
                    <div id="categoriesList" style="max-height: 300px; overflow-y: auto;">
                        <!-- Categories will be populated here -->
                    </div>
                </div>
            </div>
            <div class="modal-footer" style="padding: 16px 20px;">
                <button class="btn btn-secondary" onclick="closeModal('manageCategoriesModal')">Close</button>
            </div>
        </div>
    </div>

    <!-- BULK UPLOAD MODAL -->
    <div class="modal-overlay" id="bulkUploadModal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">Bulk Upload Prompts</span>
                <button class="modal-close" onclick="closeModal('bulkUploadModal')">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18" />
                        <line x1="6" y1="6" x2="18" y2="18" />
                    </svg>
                </button>
            </div>
            <div class="modal-body">
                <p style="color: var(--text-secondary); margin-bottom: 16px; font-size: 13px;">Upload a JSON file with
                    multiple prompts. Expected format:</p>
                <pre
                    style="background: var(--bg-tertiary); padding: 12px; border-radius: var(--radius-md); font-size: 11px; font-family: 'JetBrains Mono'; overflow-x: auto; margin-bottom: 16px;">[
  {
    "title": "Prompt Name",
    "category": "Marketing",
    "description": "Short description",
    "content": "Act as an expert...",
    "tier": "free"
  }
]</pre>
                <div class="form-group">
                    <label>Select JSON File</label>
                    <input type="file" class="form-input" id="bulkUploadFile" accept=".json" style="padding: 8px;">
                </div>
                <div id="bulkUploadStatus"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('bulkUploadModal')">Cancel</button>
                <button class="btn btn-accent" onclick="processBulkUpload()">Upload Prompts</button>
            </div>
        </div>
    </div>

    <!-- CONFIRM MODAL -->
    <div class="modal-overlay" id="confirmModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-body" style="padding: 24px;">
                <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;" id="confirmTitle">Confirm</h3>
                <p style="color: var(--text-secondary); font-size: 13px;" id="confirmMessage"></p>
                <p style="color: var(--text-muted); font-size: 12px; margin-top: 8px;" id="confirmWarning"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal('confirmModal')">Cancel</button>
                <button class="btn btn-accent" id="confirmOkBtn">OK</button>
            </div>
        </div>
    </div>

    <!-- ALERT MODAL -->
    <div class="modal-overlay" id="alertModal">
        <div class="modal" style="max-width: 400px;">
            <div class="modal-body" style="padding: 24px;">
                <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;" id="alertTitle">ai-chatworks.com
                    says</h3>
                <p style="color: var(--text-secondary); font-size: 13px;" id="alertMessage"></p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-accent" onclick="closeModal('alertModal')">OK</button>
            </div>
        </div>
    </div>

    <!-- PROMPT MODAL -->
    <div class="modal-overlay" id="promptModal">
        <div class="modal" style="max-width: 450px;">
            <div class="modal-body" style="padding: 24px;">
                <h3 style="font-size: 15px; font-weight: 600; margin-bottom: 12px;" id="promptTitle">ai-chatworks.com
                    says</h3>
                <p style="color: var(--text-secondary); font-size: 13px; margin-bottom: 16px;" id="promptMessage"></p>
                <input type="text" id="promptInput" class="form-input" style="width: 100%; padding: 10px 12px;">
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closePromptModal(false)">Cancel</button>
                <button class="btn btn-accent" onclick="closePromptModal(true)">OK</button>
            </div>
        </div>
    </div>

    <script data-cfasync="false" src="/cdn-cgi/scripts/5c5dd728/cloudflare-static/email-decode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script>
        // ═══════════════════════════════════════
        // STATE
        // ═══════════════════════════════════════
        let allMarketplaceData = [];
        let currentUser = { email: 'admin@aichatworks.com' };
        let growthChart = null;

        // Demo data for the mockup
        const DEMO_DATA = {
            users: 2847,
            prompts: 14203,
            folders: 891,
            activeUsers: 1842,
            marketplacePrompts: [
                { id: '1', title: 'SEO Content Writer Pro', category: 'Marketing', description: 'Generate SEO-optimized articles', content: 'You are an SEO expert...', tier: 'pro', is_active: true, downloads_count: 12847, uploader_email: 'admin@aichatworks.com' },
                { id: '2', title: 'Code Assistant Ultimate', category: 'Coding', description: 'Debug and optimize code', content: 'You are a coding expert...', tier: 'pro', is_active: true, downloads_count: 9523, uploader_email: 'dev@aichatworks.com' },
                { id: '3', title: 'Email Composer', category: 'Business', description: 'Professional email drafts', content: 'You help write emails...', tier: 'free', is_active: true, downloads_count: 7891, uploader_email: 'admin@aichatworks.com' },
                { id: '4', title: 'Social Media Manager', category: 'Marketing', description: 'Create viral social posts', content: 'You are a social media expert...', tier: 'pro', is_active: true, downloads_count: 6234, uploader_email: 'marketing@aichatworks.com' },
                { id: '5', title: 'Data Science Helper', category: 'Coding', description: 'Analyze datasets quickly', content: 'You are a data scientist...', tier: 'pro', is_active: true, downloads_count: 5102, uploader_email: 'data@aichatworks.com' },
                { id: '6', title: 'Blog Post Generator', category: 'Writing', description: 'Create engaging blog content', content: 'You are a blog writer...', tier: 'pro', is_active: true, downloads_count: 4876, uploader_email: 'content@aichatworks.com' },
                { id: '7', title: 'Resume Builder', category: 'Business', description: 'Build professional resumes', content: 'You help create resumes...', tier: 'free', is_active: true, downloads_count: 4521, uploader_email: 'hr@aichatworks.com' },
                { id: '8', title: 'Legal Document Drafter', category: 'Business', description: 'Draft legal documents', content: 'You are a legal assistant...', tier: 'pro', is_active: false, downloads_count: 3987, uploader_email: 'legal@aichatworks.com' },
                { id: '9', title: 'Customer Support Bot', category: 'Business', description: 'Handle customer queries', content: 'You are a support agent...', tier: 'pro', is_active: true, downloads_count: 3654, uploader_email: 'support@aichatworks.com' },
                { id: '10', title: 'Product Description Writer', category: 'Marketing', description: 'Write product descriptions', content: 'You write product copy...', tier: 'free', is_active: true, downloads_count: 3210, uploader_email: 'ecom@aichatworks.com' }
            ]
        };

        // ═══════════════════════════════════════
        // AUTH
        // ═══════════════════════════════════════
        function handleLogout() {
            document.getElementById('appShell').classList.remove('visible');
            document.getElementById('loginOverlay').classList.remove('hidden');
        }

        // ═══════════════════════════════════════
        // CUSTOM DROPDOWN SYSTEM
        // ═══════════════════════════════════════
        function createCustomDropdown(selectElement) {
            const wrapper = document.createElement('div');
            wrapper.className = 'custom-dropdown';

            // Copy min-width from select element
            const minWidth = selectElement.style.minWidth;
            if (minWidth) {
                wrapper.style.minWidth = minWidth;
            }
            const height = selectElement.style.height;
            if (height) {
                wrapper.style.height = height;
            }


            const trigger = document.createElement('div');
            trigger.className = 'dropdown-trigger';

            const triggerText = document.createElement('span');
            triggerText.className = 'dropdown-trigger-text';

            const icon = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            icon.setAttribute('class', 'dropdown-icon');
            icon.setAttribute('viewBox', '0 0 24 24');
            icon.setAttribute('fill', 'none');
            icon.setAttribute('stroke', 'currentColor');
            icon.setAttribute('stroke-width', '2');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('d', 'M6 9l6 6 6-6');
            icon.appendChild(path);

            trigger.appendChild(triggerText);
            trigger.appendChild(icon);

            const menu = document.createElement('div');
            menu.className = 'dropdown-menu';

            wrapper.appendChild(trigger);
            wrapper.appendChild(menu);

            // Store reference to original select
            wrapper._selectElement = selectElement;
            wrapper._triggerText = triggerText;
            wrapper._menu = menu;
            wrapper._trigger = trigger;

            // Initialize
            updateDropdownOptions(wrapper);
            updateDropdownValue(wrapper);

            // Event listeners
            trigger.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleDropdown(wrapper);
            });

            // Close on outside click
            document.addEventListener('click', () => {
                closeDropdown(wrapper);
            });

            menu.addEventListener('click', (e) => {
                e.stopPropagation();
            });

            // Replace select with custom dropdown
            selectElement.style.display = 'none';
            selectElement.parentNode.insertBefore(wrapper, selectElement);

            return wrapper;
        }

        function updateDropdownOptions(wrapper) {
            const select = wrapper._selectElement;
            const menu = wrapper._menu;

            menu.innerHTML = '';

            Array.from(select.options).forEach((option, index) => {
                const optionDiv = document.createElement('div');
                optionDiv.className = 'dropdown-option';
                optionDiv.textContent = option.textContent;
                optionDiv.dataset.value = option.value;
                optionDiv.dataset.index = index;

                // Removed the 'selected' class toggle here to remove checkmark
                // if (option.selected) {
                //     optionDiv.classList.add('selected');
                // }

                optionDiv.addEventListener('click', () => {
                    selectDropdownOption(wrapper, index);
                });

                menu.appendChild(optionDiv);
            });
        }

        function updateDropdownValue(wrapper) {
            const select = wrapper._selectElement;
            const triggerText = wrapper._triggerText;
            const selectedOption = select.options[select.selectedIndex];

            if (selectedOption) {
                triggerText.textContent = selectedOption.textContent;
                triggerText.classList.remove('placeholder');

                // Update selected state in menu (removed checkmark logic)
                // const options = wrapper._menu.querySelectorAll('.dropdown-option');
                // options.forEach((opt, idx) => {
                //     opt.classList.toggle('selected', idx === select.selectedIndex);
                // });
            } else {
                triggerText.textContent = 'Select...';
                triggerText.classList.add('placeholder');
            }
        }

        function selectDropdownOption(wrapper, index) {
            const select = wrapper._selectElement;
            select.selectedIndex = index;

            // Trigger change event
            const event = new Event('change', { bubbles: true });
            select.dispatchEvent(event);

            updateDropdownValue(wrapper);
            closeDropdown(wrapper);
        }

        function toggleDropdown(wrapper) {
            const isActive = wrapper._trigger.classList.contains('active');

            // Close all other dropdowns
            document.querySelectorAll('.custom-dropdown').forEach(dd => {
                if (dd !== wrapper) {
                    closeDropdown(dd);
                }
            });

            if (isActive) {
                closeDropdown(wrapper);
            } else {
                openDropdown(wrapper);
            }
        }

        function openDropdown(wrapper) {
            wrapper._trigger.classList.add('active');
            wrapper._menu.classList.add('active');
        }

        function closeDropdown(wrapper) {
            wrapper._trigger.classList.remove('active');
            wrapper._menu.classList.remove('active');
        }

        function initializeCustomDropdowns() {
            // Convert all select elements with specific classes to custom dropdowns
            const selects = document.querySelectorAll('.filter-select, .form-select');
            selects.forEach(select => {
                createCustomDropdown(select);
            });
        }

        // ═══════════════════════════════════════
        // INITIALIZATION
        // ═══════════════════════════════════════
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Supabase
            if (!initSupabase()) {
                showAlert('Failed to initialize Supabase. Please refresh the page.');
                return;
            }

            // Check saved theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                document.getElementById('themeToggle').classList.add('active');
            }

            // Login form with Supabase authentication
            document.getElementById('loginForm').addEventListener('submit', handleLogin);

            // Logout button
            document.getElementById('logoutBtn').addEventListener('click', handleLogout);

            // Navigation
            document.querySelectorAll('.nav-link[data-view]').forEach(link => {
                link.addEventListener('click', () => switchView(link.dataset.view));
            });

            // Close modals on overlay click
            document.querySelectorAll('.modal-overlay').forEach(overlay => {
                overlay.addEventListener('click', (e) => {
                    if (e.target === overlay) {
                        overlay.classList.remove('active');
                    }
                });
            });

            // Initialize custom dropdowns
            initializeCustomDropdowns();
        });

        // ═══════════════════════════════════════
        // NAVIGATION
        // ═══════════════════════════════════════
        function switchView(viewId) {
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.toggle('active', link.dataset.view === viewId);
            });
            document.querySelectorAll('.view').forEach(view => {
                view.classList.toggle('active', view.id === `view${viewId.charAt(0).toUpperCase() + viewId.slice(1)}`);
            });

            if (viewId === 'marketplace') {
                loadMarketplaceData();
            }
        }

        // ═══════════════════════════════════════
        // DATA LOADING
        // ═══════════════════════════════════════
        async function loadDashboardData() {
            await loadDashboardDataReal();
        }

        function animateValue(id, target) {
            const el = document.getElementById(id);
            const duration = 1000;
            const start = performance.now();

            function update(now) {
                const progress = Math.min((now - start) / duration, 1);
                const eased = 1 - Math.pow(1 - progress, 3);
                el.textContent = Math.floor(target * eased).toLocaleString();
                if (progress < 1) requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        function refreshData() {
            showAlert('Data refreshed successfully!');
            loadDashboardData();
        }

        async function initChart() {
            const ctx = document.getElementById('growthChart').getContext('2d');

            if (growthChart) growthChart.destroy();

            const gradient = ctx.createLinearGradient(0, 0, 0, 260);
            gradient.addColorStop(0, 'rgba(139, 92, 246, 0.4)');
            gradient.addColorStop(1, 'rgba(139, 92, 246, 0)');

            try {
                // Load real user growth data from Supabase
                const { data, error } = await supabase.rpc('get_user_growth_data');

                if (error) throw error;

                let labels, chartData;
                if (data && data.length > 0) {
                    // Use real data
                    labels = data.map(row => new Date(row.signup_date).toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                    chartData = data.map(row => row.user_count);
                } else {
                    // Empty state - show message
                    labels = ['No data'];
                    chartData = [0];
                }

                growthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels,
                        datasets: [{
                            data: chartData,
                            fill: true,
                            backgroundColor: gradient,
                            borderColor: '#8b5cf6',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 0,
                            pointHoverRadius: 5,
                            pointHoverBackgroundColor: '#8b5cf6'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: true, grid: { display: false }, ticks: { color: '#9ca3af', font: { size: 10 } } },
                            y: {
                                beginAtZero: true,
                                grid: { color: 'rgba(0,0,0,0.05)' },
                                ticks: { color: '#9ca3af', font: { size: 11 } }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Error loading chart data:', error);
                // Show empty chart on error
                growthChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Error loading data'],
                        datasets: [{
                            data: [0],
                            fill: true,
                            backgroundColor: gradient,
                            borderColor: '#8b5cf6',
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { beginAtZero: true, grid: { color: 'rgba(0,0,0,0.05)' }, ticks: { color: '#9ca3af' } }
                        }
                    }
                });
            }
        }

        // ═══════════════════════════════════════
        // MARKETPLACE
        // ═══════════════════════════════════════
        async function loadMarketplaceData() {
            await loadMarketplaceDataReal();
        }

        function populateCategoryFilter() {
            // Extract unique categories, filtering out null/undefined/empty
            const categories = [...new Set(
                allMarketplaceData
                    .map(p => p.category)
                    .filter(c => c && c.trim())  // Filter out null, undefined, empty strings
            )].sort();

            console.log('populateCategoryFilter called');
            console.log('Extracted categories:', categories);
            console.log('allMarketplaceData length:', allMarketplaceData.length);

            const select = document.getElementById('categoryFilter');
            console.log('Category select element:', select);

            select.innerHTML = '<option value="">All Categories</option>' +
                categories.map(c => `<option value="${c}">${c}</option>`).join('');

            console.log('Category select innerHTML updated, option count:', select.options.length);

            // Update custom dropdown if it exists
            const wrapper = select.parentElement.querySelector('.custom-dropdown');
            console.log('Custom dropdown wrapper:', wrapper);

            if (wrapper && typeof updateDropdownOptions === 'function') {
                console.log('Updating custom dropdown options');
                updateDropdownOptions(wrapper);
            }
        }

        function filterMarketplace() {
            const search = document.getElementById('marketplaceSearch').value.toLowerCase();
            const category = document.getElementById('categoryFilter').value;
            const tier = document.getElementById('tierFilter').value;

            let filtered = allMarketplaceData.filter(p => {
                const matchSearch = !search || p.title.toLowerCase().includes(search);
                const matchCategory = !category || p.category === category;
                const matchTier = !tier || p.tier === tier;
                return matchSearch && matchCategory && matchTier;
            });

            renderMarketplaceTable(filtered);
        }

        function clearFilters() {
            document.getElementById('marketplaceSearch').value = '';
            document.getElementById('categoryFilter').value = '';
            document.getElementById('tierFilter').value = '';
            renderMarketplaceTable(allMarketplaceData);
        }

        function renderMarketplaceTable(data) {
            const tbody = document.getElementById('marketplaceTableBody');

            if (!data || !data.length) {
                tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">No prompts found</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(p => {
                // Map RPC function fields to expected names
                // RPC returns: prompt_id, prompt_name, category, downloads, tier, created_at, uploader_email
                const id = p.prompt_id || p.id;
                const title = p.prompt_name || p.title || 'Untitled';
                const avatar = title.split(' ').map(w => w[0] || '').slice(0, 2).join('').toUpperCase() || 'UN';
                const category = p.category || 'Uncategorized';
                const uploaderEmail = p.uploader_email || p.user_email || 'Unknown';
                const downloads = p.downloads || p.downloads_count || 0;
                const tier = p.tier || 'free';
                const isActive = p.is_active !== undefined ? p.is_active : true;

                return `
                <tr>
                    <td><input type="checkbox" class="prompt-checkbox" data-id="${id}" onchange="updateBulkSelection()" style="cursor: pointer;"></td>
                    <td>
                        <div class="table-prompt">
                            <div class="table-avatar">${avatar}</div>
                            <div>
                                <div class="table-name">${title}</div>
                                <div class="table-desc">${category} prompt</div>
                            </div>
                        </div>
                    </td>
                    <td><span class="badge badge-category">${category}</span></td>
                    <td style="color: var(--text-tertiary); font-size: 12px;">${uploaderEmail}</td>
                    <td class="mono">${downloads.toLocaleString()}</td>
                    <td><span class="badge badge-${tier}">${tier.toUpperCase()}</span></td>
                    <td>
                        <span class="badge badge-${isActive ? 'active' : 'inactive'}">${isActive ? 'Active' : 'Inactive'}</span>
                    </td>
                    <td>
                        <div class="actions-cell">
                            <button class="action-btn" onclick="openEditPromptModal('${id}')" title="Edit">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                                </svg>
                            </button>
                            <button class="action-btn danger" onclick="deletePrompt('${id}', '${title.replace(/'/g, "\\'")}')" title="Delete">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                                </svg>
                            </button>
                        </div>
                    </td>
                </tr>
            `;
            }).join('');
        }

        // ═══════════════════════════════════════
        // BULK SELECTION
        // ═══════════════════════════════════════
        function toggleAllPrompts(checked) {
            document.querySelectorAll('.prompt-checkbox').forEach(cb => cb.checked = checked);
            updateBulkSelection();
        }

        function updateBulkSelection() {
            const checked = document.querySelectorAll('.prompt-checkbox:checked');
            const bar = document.getElementById('bulkDeleteBar');
            const count = document.getElementById('selectedCount');

            if (checked.length > 0) {
                bar.classList.add('visible');
                count.textContent = checked.length;
            } else {
                bar.classList.remove('visible');
            }

            // Update select all state
            const all = document.querySelectorAll('.prompt-checkbox');
            document.getElementById('selectAll').checked = checked.length === all.length && all.length > 0;
        }

        function bulkDeletePrompts() {
            const checked = document.querySelectorAll('.prompt-checkbox:checked');
            const ids = Array.from(checked).map(cb => cb.dataset.id);

            showConfirm(
                `Delete ${ids.length} prompt(s)?`,
                'This action cannot be undone.',
                () => {
                    allMarketplaceData = allMarketplaceData.filter(p => !ids.includes(p.id));
                    DEMO_DATA.marketplacePrompts = allMarketplaceData;
                    renderMarketplaceTable(allMarketplaceData);
                    document.getElementById('selectAll').checked = false;
                    updateBulkSelection();
                    showAlert(`${ids.length} prompt(s) deleted successfully!`);
                }
            );
        }

        // ═══════════════════════════════════════
        // MODALS
        // ═══════════════════════════════════════
        function openModal(id) {
            document.getElementById(id).classList.add('active');
        }

        function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }

        function openCreatePromptModal() {
            document.getElementById('createPromptName').value = '';
            document.getElementById('createPromptDesc').value = '';
            document.getElementById('createPromptContent').value = '';
            document.querySelector('input[name="createTier"][value="free"]').checked = true;
            document.getElementById('createStatusToggle').classList.add('active');
            openModal('createPromptModal');
        }

        async function createPrompt() {
            const title = document.getElementById('createPromptName').value;
            const category = document.getElementById('createPromptCategory').value;
            const description = document.getElementById('createPromptDesc').value;
            const content = document.getElementById('createPromptContent').value;
            const tier = document.querySelector('input[name="createTier"]:checked').value;
            const isActive = document.getElementById('createStatusToggle').classList.contains('active');

            if (!title || !content) {
                showAlert('Please fill in the prompt name and content');
                return;
            }

            if (!category) {
                showAlert('Please select a category');
                return;
            }

            try {
                // Insert into database
                const { data, error } = await supabase
                    .from('marketplace_prompts')
                    .insert([{
                        user_id: currentUser.id,
                        title,
                        category,
                        description,
                        content,
                        tier,
                        is_active: isActive
                    }])
                    .select();

                if (error) throw error;

                // Reload marketplace data
                await loadMarketplaceData();

                closeModal('createPromptModal');
                showAlert('Prompt created successfully!');

                // Clear form
                document.getElementById('createPromptName').value = '';
                document.getElementById('createPromptDesc').value = '';
                document.getElementById('createPromptContent').value = '';
                document.getElementById('createStatusToggle').classList.add('active');
            } catch (error) {
                console.error('Error creating prompt:', error);
                showAlert('Error creating prompt: ' + error.message);
            }
        }

        async function openEditPromptModal(id) {
            try {
                // Fetch full prompt data from database (RPC only returns summary)
                const { data: fullPrompt, error } = await supabase
                    .from('marketplace_prompts')
                    .select('*')
                    .eq('id', id)
                    .single();

                if (error) throw error;

                if (!fullPrompt) {
                    console.error('Prompt not found:', id);
                    showAlert('Prompt not found');
                    return;
                }

                // Populate modal categories first
                populateModalCategories();

                // Map database fields to form fields
                document.getElementById('editPromptId').value = id;
                document.getElementById('editPromptName').value = fullPrompt.title || '';
                document.getElementById('editPromptCategory').value = fullPrompt.category || '';
                document.getElementById('editPromptDesc').value = fullPrompt.description || '';
                document.getElementById('editPromptContent').value = fullPrompt.content || '';

                const tier = fullPrompt.tier || 'free';
                const tierRadio = document.querySelector(`input[name="editTier"][value="${tier}"]`);
                if (tierRadio) tierRadio.checked = true;

                const isActive = fullPrompt.is_active !== undefined ? fullPrompt.is_active : true;
                const toggle = document.getElementById('editStatusToggle');
                if (toggle) {
                    if (isActive) {
                        toggle.classList.add('active');
                    } else {
                        toggle.classList.remove('active');
                    }
                }

                openModal('editPromptModal');
            } catch (error) {
                console.error('Error loading prompt:', error);
                showAlert('Error loading prompt: ' + error.message);
            }
        }

        function populateModalCategories() {
            // Get unique categories from loaded data
            const categories = [...new Set(
                allMarketplaceData
                    .map(p => p.category)
                    .filter(c => c && c.trim())
            )].sort();

            // Populate both create and edit modals
            const createSelect = document.getElementById('createPromptCategory');
            const editSelect = document.getElementById('editPromptCategory');

            const optionsHTML = '<option value="">Select Category</option>' +
                categories.map(c => `<option value="${c}">${c}</option>`).join('');

            if (createSelect) {
                createSelect.innerHTML = optionsHTML;
                // Update custom dropdown if it exists
                const customDropdown = createSelect.parentElement.querySelector('.custom-dropdown');
                if (customDropdown) {
                    updateDropdownOptions(customDropdown);
                }
            }

            if (editSelect) {
                editSelect.innerHTML = optionsHTML;
                // Update custom dropdown if it exists
                const customDropdown = editSelect.parentElement.querySelector('.custom-dropdown');
                if (customDropdown) {
                    updateDropdownOptions(customDropdown);
                }
            }
        }

        async function updatePrompt() {
            const id = document.getElementById('editPromptId').value;
            const title = document.getElementById('editPromptName').value;
            const category = document.getElementById('editPromptCategory').value;
            const description = document.getElementById('editPromptDesc').value;
            const content = document.getElementById('editPromptContent').value;
            const tier = document.querySelector('input[name="editTier"]:checked').value;
            const isActive = document.getElementById('editStatusToggle').classList.contains('active');

            if (!title || !content) {
                showAlert('Please fill in the prompt name and content');
                return;
            }

            if (!category) {
                showAlert('Please select a category');
                return;
            }

            try {
                // Update in database
                const { error } = await supabase
                    .from('marketplace_prompts')
                    .update({
                        title,
                        category,
                        description,
                        content,
                        tier,
                        is_active: isActive,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;

                // Reload marketplace data
                await loadMarketplaceData();

                closeModal('editPromptModal');
                showAlert('Prompt updated successfully!');
            } catch (error) {
                console.error('Error updating prompt:', error);
                showAlert('Error updating prompt: ' + error.message);
            }
        }

        async function deletePrompt(id, title) {
            console.log('deletePrompt called with id:', id, 'title:', title);
            showConfirm(
                `Delete "${title}"?`,
                'This action cannot be undone.',
                async () => {
                    console.log('Delete confirmed, executing delete for id:', id);
                    try {
                        const { error } = await supabase
                            .from('marketplace_prompts')
                            .delete()
                            .eq('id', id);

                        if (error) {
                            console.error('Supabase delete error:', error);
                            throw error;
                        }

                        console.log('Delete successful, reloading marketplace data');
                        // Reload marketplace data
                        await loadMarketplaceData();

                        showAlert('Prompt deleted successfully!');
                    } catch (error) {
                        console.error('Error deleting prompt:', error);
                        showAlert('Error deleting prompt: ' + error.message);
                    }
                }
            );
        }

        // ═══════════════════════════════════════
        // CATEGORY MANAGEMENT
        // ═══════════════════════════════════════
        async function openManageCategoriesModal() {
            await loadCategoriesList();
            openModal('manageCategoriesModal');
        }

        async function loadCategoriesList() {
            const categories = [...new Set(
                allMarketplaceData
                    .map(p => p.category)
                    .filter(c => c && c.trim())
            )].sort();

            const listContainer = document.getElementById('categoriesList');

            if (categories.length === 0) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-muted);">No categories yet. Add one above!</div>';
                return;
            }

            listContainer.innerHTML = categories.map(category => `
                <div class="category-item" style="display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border: 1px solid var(--border); border-radius: var(--radius-md); margin-bottom: 6px; background: var(--bg-primary);">
                    <span class="category-name" style="flex: 1; font-size: 14px; color: var(--text-primary);">${category}</span>
                    <div style="display: flex; gap: 6px;">
                        <button class="btn btn-ghost" onclick="editCategory('${category.replace(/'/g, "\\'")}');" style="padding: 4px 10px; font-size: 12px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/>
                            </svg>
                            Edit
                        </button>
                        <button class="btn btn-danger" onclick="deleteCategory('${category.replace(/'/g, "\\'")}')" style="padding: 4px 10px; font-size: 12px;">
                            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <path d="M3 6h18M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/>
                            </svg>
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        async function addCategory() {
            const input = document.getElementById('newCategoryInput');
            const categoryName = input.value.trim();

            if (!categoryName) {
                showAlert('Please enter a category name');
                return;
            }

            // Check if category already exists
            const existingCategories = [...new Set(
                allMarketplaceData
                    .map(p => p.category)
                    .filter(c => c && c.trim())
            )];

            if (existingCategories.some(c => c.toLowerCase() === categoryName.toLowerCase())) {
                showAlert('Category already exists');
                return;
            }

            try {
                // Create a placeholder prompt to register the category in the database
                const { error } = await supabase
                    .from('marketplace_prompts')
                    .insert([{
                        user_id: currentUser.id,
                        title: `_category_placeholder_${categoryName}`,
                        content: 'Placeholder',
                        description: 'Placeholder for category',
                        category: categoryName,
                        tier: 'free',
                        is_active: false
                    }]);

                if (error) throw error;

                input.value = '';

                // Reload marketplace data to include new category
                await loadMarketplaceData();
                await loadCategoriesList();

                showAlert(`Category "${categoryName}" added successfully`);
            } catch (error) {
                console.error('Error adding category:', error);
                showAlert('Error adding category: ' + error.message);
            }
        }

        async function editCategory(oldName) {
            showPrompt(`Rename category "${oldName}" to:`, oldName, async (newName) => {
                if (!newName || newName.trim() === '') {
                    return;
                }

                if (newName.trim() === oldName) {
                    return;
                }

                try {
                    // Update all prompts with this category
                    const { error } = await supabase
                        .from('marketplace_prompts')
                        .update({ category: newName.trim() })
                        .eq('category', oldName);

                    if (error) throw error;

                    // Reload data
                    await loadMarketplaceData();
                    await loadCategoriesList();

                    showAlert(`Category renamed from "${oldName}" to "${newName.trim()}"`);
                } catch (error) {
                    console.error('Error renaming category:', error);
                    showAlert('Error renaming category: ' + error.message);
                }
            });
        }

        async function deleteCategory(categoryName) {
            console.log('deleteCategory called for:', categoryName);
            // Count prompts in this category
            const promptCount = allMarketplaceData.filter(p => p.category === categoryName).length;
            console.log('Prompt count in category:', promptCount);

            if (promptCount > 0) {
                showConfirm(
                    `Delete category "${categoryName}"?`,
                    `This category has ${promptCount} prompt(s). They will be set to "Uncategorized".`,
                    async () => {
                        console.log('Delete confirmed for category:', categoryName);
                        try {
                            // Update all prompts in this category to "Uncategorized"
                            const { error } = await supabase
                                .from('marketplace_prompts')
                                .update({ category: 'Uncategorized' })
                                .eq('category', categoryName);

                            if (error) {
                                console.error('Supabase error deleting category:', error);
                                throw error;
                            }

                            console.log('Category update successful, reloading data');
                            // Reload data
                            await loadMarketplaceData();
                            await loadCategoriesList();

                            showAlert(`Category "${categoryName}" deleted. ${promptCount} prompt(s) moved to "Uncategorized"`);
                        } catch (error) {
                            console.error('Error deleting category:', error);
                            showAlert('Error deleting category: ' + error.message);
                        }
                    }
                );
            } else {
                console.log('Category has no prompts');
                showAlert(`Category "${categoryName}" has no prompts and will be removed automatically.`);
                await loadCategoriesList();
            }
        }

        // ═══════════════════════════════════════
        // BULK OPERATIONS
        // ═══════════════════════════════════════
        function openBulkUploadModal() {
            document.getElementById('bulkUploadFile').value = '';
            document.getElementById('bulkUploadStatus').innerHTML = '';
            openModal('bulkUploadModal');
        }

        function processBulkUpload() {
            const fileInput = document.getElementById('bulkUploadFile');
            const statusDiv = document.getElementById('bulkUploadStatus');

            if (!fileInput.files || !fileInput.files[0]) {
                showAlert('Please select a JSON file');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const prompts = JSON.parse(e.target.result);
                    if (!Array.isArray(prompts)) throw new Error('JSON must be an array');

                    let success = 0;
                    prompts.forEach(p => {
                        if (p.title && p.content) {
                            allMarketplaceData.unshift({
                                id: Date.now().toString() + Math.random(),
                                title: p.title,
                                category: p.category || 'Uncategorized',
                                description: p.description || '',
                                content: p.content,
                                tier: (p.tier === 'pro') ? 'pro' : 'free',
                                is_active: true,
                                downloads_count: 0,
                                uploader_email: currentUser.email
                            });
                            success++;
                        }
                    });

                    DEMO_DATA.marketplacePrompts = allMarketplaceData;
                    renderMarketplaceTable(allMarketplaceData);
                    statusDiv.innerHTML = `<p style="color: var(--success);">✓ ${success} prompts uploaded successfully!</p>`;

                    setTimeout(() => closeModal('bulkUploadModal'), 1500);
                } catch (err) {
                    statusDiv.innerHTML = `<p style="color: var(--danger);">Error: ${err.message}</p>`;
                }
            };
            reader.readAsText(fileInput.files[0]);
        }

        // Alert & Confirm modals
        function showAlert(message) {
            document.getElementById('alertMessage').textContent = message;
            openModal('alertModal');
        }

        function showConfirm(message, warning, onConfirm) {
            document.getElementById('confirmMessage').textContent = message;
            document.getElementById('confirmWarning').textContent = warning || '';

            const okBtn = document.getElementById('confirmOkBtn');
            okBtn.onclick = async () => {
                closeModal('confirmModal');
                try {
                    await onConfirm();
                } catch (error) {
                    console.error('Error in confirm callback:', error);
                    showAlert('An error occurred: ' + error.message);
                }
            };

            openModal('confirmModal');
        }

        let promptCallback = null;
        function showPrompt(message, defaultValue, onSubmit) {
            document.getElementById('promptMessage').textContent = message;
            document.getElementById('promptInput').value = defaultValue || '';
            promptCallback = onSubmit;
            openModal('promptModal');

            // Focus input after modal opens
            setTimeout(() => {
                document.getElementById('promptInput').focus();
                document.getElementById('promptInput').select();
            }, 100);
        }

        function closePromptModal(confirmed) {
            const value = document.getElementById('promptInput').value;
            closeModal('promptModal');

            if (confirmed && promptCallback) {
                promptCallback(value);
            }
            promptCallback = null;
        }

        // ═══════════════════════════════════════
        // QUERY CONSOLE
        // ═══════════════════════════════════════
        function updateQueryParams() {
            const query = document.getElementById('querySelector').value;
            const paramsDiv = document.getElementById('queryParams');

            const configs = {
                find_user: '<div class="form-group"><label>Email</label><input type="text" class="form-input" id="paramEmail" placeholder="user@example.com"></div>',
                heavy_users: '<div class="form-group"><label>Min Prompts</label><input type="number" class="form-input" id="paramMinPrompts" value="10"></div>',
                inactive_users: '<div class="form-group"><label>Days Inactive</label><input type="number" class="form-input" id="paramDays" value="30"></div>',
                default: '<div class="form-group"><label>Limit Results</label><input type="number" class="form-input" id="paramLimit" value="10" min="1" max="100"></div>'
            };

            paramsDiv.innerHTML = configs[query] || configs.default;
        }

        async function runQuery() {
            const query = document.getElementById('querySelector').value;
            const output = document.getElementById('consoleOutput');

            output.innerHTML = '<div class="console-line info">Executing query...</div>';

            try {
                let result;

                switch (query) {
                    case 'recent_users':
                        const limit = parseInt(document.getElementById('paramLimit')?.value) || 10;
                        const { data: users, error: usersError } = await supabase.rpc('admin_get_recent_users', { limit_count: limit });
                        if (usersError) throw usersError;
                        result = JSON.stringify(users, null, 2);
                        break;

                    case 'db_stats':
                        // Use the admin_get_db_stats function that returns all stats in one query
                        const { data: stats, error: statsError } = await supabase.rpc('admin_get_db_stats');
                        if (statsError) throw statsError;

                        // Format the response
                        const formattedStats = stats && stats.length > 0 ? {
                            total_users: stats[0].total_users || 0,
                            total_prompts: stats[0].total_prompts || 0,
                            total_folders: stats[0].total_folders || 0,
                            encrypted_prompts: stats[0].encrypted_prompts || 0,
                            encrypted_folders: stats[0].encrypted_folders || 0,
                            encrypted_items: (stats[0].encrypted_prompts || 0) + (stats[0].encrypted_folders || 0),
                            marketplace_prompts: stats[0].marketplace_prompts || 0,
                            total_downloads: stats[0].total_downloads || 0
                        } : {};

                        result = JSON.stringify(formattedStats, null, 2);
                        break;

                    default:
                        result = 'Query not found. Available queries: recent_users, db_stats';
                }

                output.innerHTML = `
                    <div class="console-line success">✓ Query executed successfully</div>
                    <pre style="margin-top: 12px; white-space: pre-wrap;">${result}</pre>
                `;
            } catch (error) {
                console.error('Query error:', error);
                output.innerHTML = `
                    <div class="console-line error">✗ Query failed: ${error.message}</div>
                    <pre style="margin-top: 12px; white-space: pre-wrap; color: var(--error);">${JSON.stringify(error, null, 2)}</pre>
                `;
            }
        }

        // ═══════════════════════════════════════
        // THEME
        // ═══════════════════════════════════════
        function toggleTheme() {
            const toggle = document.getElementById('themeToggle');
            const isDark = toggle.classList.toggle('active');

            document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
            localStorage.setItem('theme', isDark ? 'dark' : 'light');
        }

        // ═══════════════════════════════════════
        // SUPABASE CONFIGURATION & AUTHENTICATION
        // ═══════════════════════════════════════
        const SUPABASE_CONFIG = {
            url: 'https://ldcapthzveqdbvthukiz.supabase.co',
            anonKey: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxkY2FwdGh6dmVxZGJ2dGh1a2l6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwOTM0NDEsImV4cCI6MjA3ODY2OTQ0MX0.mPNwwP_VFWpVso8hSy2I-ECH8v80EscFfEHeu2eiREc'
        };

        let supabase = null;
        const ADMIN_ROLE = 'admin';

        async function handleLogin(e) {
            e.preventDefault();

            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');

            try {
                const { data, error } = await supabase.auth.signInWithPassword({
                    email: email,
                    password: password
                });

                if (error) throw error;

                // Check admin role
                const { data: profile } = await supabase
                    .from('user_profiles')
                    .select('role')
                    .eq('id', data.user.id)
                    .single();

                if (profile?.role !== ADMIN_ROLE) {
                    await supabase.auth.signOut();
                    throw new Error('Access denied: Admin role required');
                }

                currentUser = data.user;
                document.getElementById('userName').textContent = email.split('@')[0];
                document.getElementById('userAvatar').textContent = email.substring(0, 2).toUpperCase();
                document.getElementById('settingsEmail').textContent = email;

                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('appShell').classList.add('visible');

                loadDashboardData();
            } catch (error) {
                console.error('Login error:', error);
                errorEl.textContent = error.message || 'Invalid credentials';
                errorEl.style.display = 'flex';
                setTimeout(() => {
                    errorEl.style.display = 'none';
                }, 3000);
            }
        }

        async function handleLogout() {
            await supabase.auth.signOut();
            currentUser = null;
            document.getElementById('appShell').classList.remove('visible');
            document.getElementById('loginOverlay').classList.remove('hidden');
        }

        function initSupabase() {
            if (typeof window.supabase === 'undefined') {
                console.error('Supabase client not loaded');
                showAlert('Error: Supabase not loaded. Please refresh the page.');
                return false;
            }
            supabase = window.supabase.createClient(SUPABASE_CONFIG.url, SUPABASE_CONFIG.anonKey);
            return true;
        }

        // Update loadDashboardData to use real Supabase data
        async function loadDashboardDataReal() {
            try {
                // Load real stats from Supabase
                const { data: userData } = await supabase.rpc('get_total_users');
                if (userData !== null) animateValue('statUsers', userData);

                const { data: promptData } = await supabase.rpc('get_total_prompts');
                if (promptData !== null) animateValue('statPrompts', promptData);

                const { data: folderData } = await supabase.rpc('get_total_folders');
                if (folderData !== null) animateValue('statFolders', folderData);

                const { data: encryptedData } = await supabase.rpc('get_encrypted_items_count');
                if (encryptedData !== null) animateValue('statEncrypted', encryptedData);

                // Load marketplace stats
                const { data: allPrompts } = await supabase
                    .from('marketplace_prompts')
                    .select('tier, downloads_count, title, category, is_active');

                if (allPrompts) {
                    const totalPrompts = allPrompts.length;
                    const proPrompts = allPrompts.filter(p => p.tier === 'pro').length;
                    const freePrompts = allPrompts.filter(p => p.tier === 'free').length;
                    const inactivePrompts = allPrompts.filter(p => !p.is_active).length;

                    document.getElementById('mpTotalPrompts').textContent = totalPrompts;
                    document.getElementById('mpProPrompts').textContent = proPrompts;
                    document.getElementById('mpFreePrompts').textContent = freePrompts;
                    document.getElementById('mpInactivePrompts').textContent = inactivePrompts;
                    document.getElementById('marketplaceBadge').textContent = totalPrompts;

                    // Top prompts table
                    const topPrompts = [...allPrompts].sort((a, b) => (b.downloads_count || 0) - (a.downloads_count || 0)).slice(0, 5);
                    if (topPrompts.length > 0) {
                        document.getElementById('topPromptsTable').innerHTML = topPrompts.map(p => {
                            const title = p.title || 'Untitled';
                            const avatar = title.split(' ').map(w => w[0] || '').slice(0, 2).join('').toUpperCase() || 'UN';
                            const category = p.category || 'Uncategorized';
                            const tier = p.tier || 'free';
                            const downloads = p.downloads_count || 0;

                            return `
                            <tr>
                                <td>
                                    <div class="table-prompt">
                                        <div class="table-avatar">${avatar}</div>
                                        <div>
                                            <div class="table-name">${title}</div>
                                            <div class="table-desc">${category}</div>
                                        </div>
                                    </div>
                                </td>
                                <td><span class="badge badge-category">${category}</span></td>
                                <td class="mono">${downloads.toLocaleString()}</td>
                                <td><span class="badge badge-${tier}">${tier.toUpperCase()}</span></td>
                            </tr>
                        `;
                        }).join('');
                    } else {
                        document.getElementById('topPromptsTable').innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted);">No prompts yet</td></tr>';
                    }
                }

                // Engagement
                const monthStart = new Date();
                monthStart.setDate(1);
                monthStart.setHours(0, 0, 0, 0);

                const { data: activePrompts } = await supabase
                    .from('prompts')
                    .select('user_id')
                    .gte('updated_at', monthStart.toISOString());

                const { data: activeFolders } = await supabase
                    .from('folders')
                    .select('user_id')
                    .gte('updated_at', monthStart.toISOString());

                const activeUserIds = new Set([
                    ...(activePrompts || []).map(p => p.user_id),
                    ...(activeFolders || []).map(f => f.user_id)
                ]);

                const activeCount = activeUserIds.size;
                const totalUsers = userData || 1;
                const engagementPercent = Math.round((activeCount / totalUsers) * 100);

                document.getElementById('engagementValue').textContent = activeCount.toLocaleString();
                setTimeout(() => {
                    document.getElementById('engagementBar').style.width = engagementPercent + '%';
                    document.getElementById('engagementPercent').textContent = engagementPercent;
                }, 300);

                // Chart
                initChart();
            } catch (error) {
                console.error('Error loading dashboard data:', error);
                throw error; // Re-throw to trigger fallback
            }
        }

        // Update loadMarketplaceData to use real Supabase data
        async function loadMarketplaceDataReal() {
            console.log('=== loadMarketplaceDataReal START ===');
            try {
                const { data, error } = await supabase.rpc('admin_get_marketplace_prompts');

                if (error) {
                    console.error('RPC Error:', error);
                    throw error;
                }

                console.log('Marketplace data received:', data);
                if (data && data.length > 0) {
                    console.log('First prompt structure:', data[0]);
                    console.log('Available fields:', Object.keys(data[0] || {}));
                }

                if (!data || data.length === 0) {
                    document.getElementById('marketplaceTableBody').innerHTML = '<tr><td colspan="8" style="text-align: center; color: var(--text-muted); padding: 40px;">No marketplace prompts yet</td></tr>';
                    allMarketplaceData = [];
                    console.log('No marketplace data, allMarketplaceData set to empty array.');
                    return;
                }

                allMarketplaceData = data || [];
                console.log('allMarketplaceData set, length:', allMarketplaceData.length);

                renderMarketplaceTable(allMarketplaceData);
                console.log('Table rendered');

                // Populate category filter
                populateCategoryFilter();
                console.log('Category filter populated');

                // Populate modal categories
                await populateModalCategories();
                console.log('Modal categories populated');

            } catch (error) {
                console.error('Error in loadMarketplaceDataReal:', error);
                showAlert('Error loading marketplace data: ' + error.message);
                allMarketplaceData = [];
                throw error;
            }
            console.log('=== loadMarketplaceDataReal END ===');
        }

    </script>
</body>

</html>